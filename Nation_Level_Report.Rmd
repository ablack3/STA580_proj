---
title: "Untitled"
author: "Andrew Deighan"
date: "April 14, 2017"
output: html_document
---

```{r setup, include=FALSE}

## Importing, clean, and organize data


#library(Hmisc)
#BRFSS2015full <- sasxport.get("LLCP2015.XPT")
#BRFSS2014full <- sasxport.get("LLCP2014.XPT")
#BRFSS2013full <- sasxport.get("LLCP2013.XPT")
#BRFSS2012full <- sasxport.get("LLCP2012.XPT")
#BRFSS2011full <- sasxport.get("LLCP2011.XPT")

#t15.data <- BRFSS2015full[,c("hlthpln1", "persdoc2", "checkup1", "x.llcpwt", "x.state")]
#t14.data <- BRFSS2014full[,c("hlthpln1", "persdoc2", "checkup1", "x.llcpwt", "x.state")]
#t13.data <- BRFSS2013full[,c("hlthpln1", "persdoc2", "checkup1", "x.llcpwt", "x.state")]
#t12.data <- BRFSS2012full[,c("hlthpln1", "persdoc2", "checkup1", "x.llcpwt", "x.state")]
#t11.data <- BRFSS2011full[,c("hlthpln1", "persdoc2", "checkup1", "x.llcpwt", "x.state")]

#write.csv(t15.data, '2015 BRFSS Data.csv')
#write.csv(t14.data, '2014 BRFSS Data.csv')
#write.csv(t13.data, '2013 BRFSS Data.csv')
#write.csv(t12.data, '2012 BRFSS Data.csv')
#write.csv(t11.data, '2011 BRFSS Data.csv')

#rm(BRFSS2011full, BRFSS2012full, BRFSS2013full, BRFSS2014full, BRFSS2015full)

t15.data <- data.frame(read.csv("2015 BRFSS Data.csv")[,2:6])
t14.data <- data.frame(read.csv("2014 BRFSS Data.csv")[,2:6])
t13.data <- data.frame(read.csv("2013 BRFSS Data.csv")[,2:6])
t12.data <- data.frame(read.csv("2012 BRFSS Data.csv")[,2:6])
t11.data <- data.frame(read.csv("2011 BRFSS Data.csv")[,2:6])




### Cleaning data ###

#Clean data sets of missing values:
#
#* For hlthpln1
#      + 1: yes insurance
#      + 2: no insurance
#      + 7: unsure
#      + 9: refused to answer
#* For persdoc2
#      + 1: yes one personal doctor
#      + 2: yes more than one
#      + 3: no personal doctor
#      + 7: unsure
#      + 9: refused to answer
#* For checkup1
#      + 1: checkup within past year
#      + 2: checkup within two years
#      + 3: checkup within five years
#      + 4: more than five years since checkup
#      + 7: unsure
#      + 8: never had checkup
#      + 9: refused to answer

cleaner <- function(x){
      df <- x
      for(i in 1:5){
            df <- df[!is.na(df[,i]),] 
      }
      
      for(i in 1:3){
           df <- df[df[,i] != 7 & df[,i] != 9,] 
      }

      
      df
}

t11.data <- cleaner(t11.data)
t12.data <- cleaner(t12.data)
t13.data <- cleaner(t13.data)
t14.data <- cleaner(t14.data)
t15.data <- cleaner(t15.data)

# Since we are only interested in whether or not respondents have a personal doctor we will treat those who reported having multiple doctors and those who reported only having one doctor the same. Now individuals with personal doctors will be coded as '1' and those without as '3'.

persdocmod <- function(x){
      df <- x
      df[df[,2] == 2,2] <- 1
      
      df
}

t11.data <- persdocmod(t11.data)
t12.data <- persdocmod(t12.data)
t13.data <- persdocmod(t13.data)
t14.data <- persdocmod(t14.data)
t15.data <- persdocmod(t15.data)

allyears <- rbind(t11.data, t12.data, t13.data, t14.data, t15.data)


### Create Summary Tables with Weighted Values ###


library(dplyr)

persdoc.table <- function(x){
      
      tab <- x %>% group_by(hlthpln1, persdoc2) %>% summarize(wt_sum = sum(x.llcpwt)) %>% 
      tidyr::spread(key = persdoc2, value = wt_sum) %>% ungroup()
      
      tab
}

ST_PD_t11 <- persdoc.table(t11.data)
ST_PD_t12 <- persdoc.table(t12.data)
ST_PD_t13 <- persdoc.table(t13.data)
ST_PD_t14 <- persdoc.table(t14.data)
ST_PD_t15 <- persdoc.table(t15.data)
ST_PD_ay <- persdoc.table(allyears)

checkup.table <- function(x){
      
      tab <- x %>% group_by(hlthpln1, checkup1) %>% summarize(wt_sum = sum(x.llcpwt)) %>% 
      tidyr::spread(key = checkup1, value = wt_sum) %>% ungroup()
      
      tab
}

ST_CU_t11 <- checkup.table(t11.data)
ST_CU_t12 <- checkup.table(t12.data)
ST_CU_t13 <- checkup.table(t13.data)
ST_CU_t14 <- checkup.table(t14.data)
ST_CU_t15 <- checkup.table(t15.data)
ST_CU_ay <- checkup.table(allyears)

ST_CUgPD_t11 <- checkup.table(t11.data[t11.data$persdoc2 == 1,])
ST_CUgPD_t12 <- checkup.table(t12.data[t12.data$persdoc2 == 1,])
ST_CUgPD_t13 <- checkup.table(t13.data[t13.data$persdoc2 == 1,])
ST_CUgPD_t14 <- checkup.table(t14.data[t14.data$persdoc2 == 1,])
ST_CUgPD_t15 <- checkup.table(t15.data[t15.data$persdoc2 == 1,])
ST_CUgPD_ay <- checkup.table(allyears[allyears$persdoc2 == 1,])

```


## Methods and Results

  For our study we used data from the BRFSS surveys from 2011 through 2015 to study the relationship between insurance status and measures of primary care access and utilization.

* Insurance Status: Do you have any kind of health care coverage, including health insurance, prepaid plans such as HMOs, or government plans such as Medicare, or Indian Health Service?
    + 1: Yes
    + 2: No
    + 7: Don't know/Not Sure
    + 9: Refused
* Personal Doctor: Do you have one person you think of as your personal doctor or health care provider? (If "No" ask "Is there more than one or is there no person who you think of as your personal doctor or health care provider?".)
    + 1: Yes, only one
    + 2: More than one
    + 3: No
    + 7: Don't know/Not Sure
    + 9: Refused
* Doctor Utilization: About how long has it been since you last visited a doctor for a routine checkup? [A routine checkup is a general physical exam, not an exam for a specific injury, illness, or condition.]
    + 1: Within past year (anytime less than 12 months ago)
    + 2: Within past 2 years (1 year but less than 2 years ago)
    + 3: Within past 5 years (2 years but less than 5 years ago)
    + 4: 5 or more years ago
    + 7: Don't know/Not sure
    + 8: Never
    + 9: Refused  
<br>
<br>
    
  The first part of our study considers that nation as a whole when investigating the relationships between insurance status and our measures of access to, and utilization of, primary care. For this part of the study we considered three measures as proxies of primary care access and utilization:

* Personal Doctor: Whether or not an individual reported having a personal doctor
* Doctor Utilization: The reported period of time since last general checkup. We only looked at two levels for this part of the analysis. For information on all levels see appendix.
    + Within the past year
    + Not within the past five years (aggregate of "5 or more years ago" and "Never")
* Doctor Utilization given Personal Doctor: Same as above, but only considering individuals who reported having a personal doctor  
<br>
<br>

  First we will look at some bar charts to get a quick visualization of the data. Figure 1 shows the proportion of insured and uninsured individuals with a personal doctor for years 2011 through 2015 and all years combined.

```{r, include=F}

PD.props <- function(x){
      vec <- rep(0,4)
      c <- 0
      for(i in 1:2){
            for(j in 2:3){
                  c <- c + 1
                  vec[c] <- as.numeric(x[i,j]/sum(x[i,2:3]))   
            }
      }
      matrix(vec, nrow = 2, ncol = 2, byrow = TRUE)
}


PD11 <- PD.props(ST_PD_t11)
PD12 <- PD.props(ST_PD_t12)
PD13 <- PD.props(ST_PD_t13)
PD14 <- PD.props(ST_PD_t14)
PD15 <- PD.props(ST_PD_t15)
PDay <- PD.props(ST_PD_ay)

PD.proportions <- matrix(c(PD11[,1],PD12[,1],PD13[,1],PD14[,1],PD15[,1],PDay[,1], 0, 0), nrow = 2, ncol = 7,
                         dimnames = list(c("Insured", "Uninsured"),
                                         c("2011", "2012", "2013", "2014", "2015", "All Years", "Empty"))
                         )

png("plots/Proportion_of_Individuals_with_a_Personal_Doctor.png",
     height = 240, width = 480)

par(mar = c(4, 2.5, 3, 2.5))
barplot(PD.proportions, beside = TRUE, 
        names.arg = c("2011", "2012", "2013", "2014", "2015", "All Years", ""),
        main = c('Proportion of Individuals with a Personal Doctor'), 
        col = c('green', 'forestgreen')
        )
legend("topright",
       inset=0,
       cex = 1,
       c("Insured","Uninsured"),
       pch=20,
       pt.cex = 2,
       col=c("green","forestgreen"),
       bty = "n"
       )
abline(h=0)

dev.off()

```

***

![**Figure 1:** The proportion of insured and uninsured individuals who reported having a personal doctor.](plots\Proportion_of_Individuals_with_a_Personal_Doctor.png)

***

  From the barplot above it appears evident that the proportion of individuals that have a personal doctor is higher for those with insurance than those without. The presence of this trend appears consistent from 2011 through 2015.  
<br>
<br>

  Now we will look at doctor utilization for insured and uninsured individuals. Figure 2 shows information on the proportion of individuals that have had a general checkup within one year and those that have not had a checkup within the last five years. Figure 3 shows the same thing but it restricts the pool to only individuals that reported having a personal doctor. For more information on the proportions for all the individual levels of the doctor utilization measure see the appendix (***link here***).
  
```{r, include=F}

CU.props <- function(x){
      
      vec <- rep(0,10)
      c <- 0
      
      for(i in 1:2){
            for(j in 2:6){
                  c <- c+1
                  vec[c] <- as.numeric(x[i,j]/sum(x[i,2:6]))
            }
      }
      
      matrix(vec, nrow = 2, ncol = 5, byrow = TRUE)
}

CUgPD.props <- function(x){
      
      vec <- rep(0,10)
      c <- 0
      
      for(i in 1:2){
            for(j in 2:6){
                  c <- c+1
                  vec[c] <- as.numeric(x[i,j]/sum(x[i,2:6]))
            }
      }
      
      matrix(vec, nrow = 2, ncol = 5, byrow = TRUE)
}

CUgPD11 <- CUgPD.props(ST_CUgPD_t11)
CUgPD12 <- CUgPD.props(ST_CUgPD_t12)
CUgPD13 <- CUgPD.props(ST_CUgPD_t13)
CUgPD14 <- CUgPD.props(ST_CUgPD_t14)
CUgPD15 <- CUgPD.props(ST_CUgPD_t15)
CUgPDay <- CUgPD.props(ST_CUgPD_ay)

CU11 <- CU.props(ST_CU_t11)
CU12 <- CU.props(ST_CU_t12)
CU13 <- CU.props(ST_CU_t13)
CU14 <- CU.props(ST_CU_t14)
CU15 <- CU.props(ST_CU_t15)
CUay <- CU.props(ST_CU_ay)

vec <- c(CU11[,1], CU12[,1], CU13[,1], CU14[,1], CU15[,1], CUay[,1])

DU.l1.proportions <- matrix(vec, nrow = 2, ncol = 6,
                         dimnames = list( c("Insured", "Uninsured"),
                          c("2011", "2012", "2013", "2014", "2015", "All") )
                         )

vec <- c(sum(CU11[1,4:5]), sum(CU11[2,4:5]),
         sum(CU12[1,4:5]), sum(CU12[2,4:5]),
         sum(CU13[1,4:5]), sum(CU13[2,4:5]),
         sum(CU14[1,4:5]), sum(CU14[2,4:5]),
         sum(CU15[1,4:5]), sum(CU15[2,4:5]),
         sum(CUay[1,4:5]), sum(CUay[2,4:5]),
         0,0)


DU.g1.proportions <- matrix(vec, nrow = 2, ncol = 7,
                         dimnames = list( c("Insured", "Uninsured"),
                          c("2011", "2012", "2013", "2014", "2015", "All", "" ) )
                         )


png("plots/Difference_in_Doctor_Utilization.png",
     height = 240, width = 800)

par(mfrow=c(1,2), mai = c(.7,.5,.7,.4), cex = .9, oma = c(0,0,2,0), font.main = 1, cex.axis = .9)
barplot(DU.l1.proportions, beside = TRUE, 
        names.arg = c("2011", "2012", "2013", "2014", "2015", "All Years"),
        main = c('Checkup within 1 Year'), 
        col = c('green', 'forestgreen'),
        width = .9, space = c(0,1.5)
        )
abline(h=0)

barplot(DU.g1.proportions, beside = TRUE, 
        names.arg = c("2011", "2012", "2013", "2014", "2015", "All Years", ""),
        main = c('No Checkup within 5 Years'), 
        col = c('green', 'forestgreen'),
        width = .9, space = c(0,1.5)
        )
legend("topright",
       inset=0,
       cex = .8,
       c("Insured","Uninsured"),
       pch=20,
       pt.cex = 2,
       col=c("green","forestgreen"),
       bty = "n"
       )
abline(h=0)

mtext('Difference in Doctor Utilization between Insured and Uninsured Groups', outer = TRUE, font = 2)

dev.off()

### No for doctor utilization given personal doctor

vec <- c(CUgPD11[,1], CUgPD12[,1], CUgPD13[,1], CUgPD14[,1], CUgPD15[,1], CUgPDay[,1])

DUgPD.l1.proportions <- matrix(vec, nrow = 2, ncol = 6,
                         dimnames = list( c("Insured", "Uninsured"),
                          c("2011", "2012", "2013", "2014", "2015", "All") )
                         )

vec <- c(sum(CUgPD11[1,4:5]), sum(CUgPD11[2,4:5]),
         sum(CUgPD12[1,4:5]), sum(CUgPD12[2,4:5]),
         sum(CUgPD13[1,4:5]), sum(CUgPD13[2,4:5]),
         sum(CUgPD14[1,4:5]), sum(CUgPD14[2,4:5]),
         sum(CUgPD15[1,4:5]), sum(CUgPD15[2,4:5]),
         sum(CUgPDay[1,4:5]), sum(CUgPDay[2,4:5]),
         0,0)


DUgPD.g1.proportions <- matrix(vec, nrow = 2, ncol = 7,
                         dimnames = list( c("Insured", "Uninsured"),
                          c("2011", "2012", "2013", "2014", "2015", "All", "" ) )
                         )


png("plots/Difference_in_Doctor_Utilization_Given_PD.png",
     height = 240, width = 800)

par(mfrow=c(1,2), mai = c(.7,.5,.7,.4), cex = .9, oma = c(0,0,2,0), font.main = 1, cex.axis = .9)
barplot(DUgPD.l1.proportions, beside = TRUE, 
        names.arg = c("2011", "2012", "2013", "2014", "2015", "All Years"),
        main = c('Checkup within 1 Year'), 
        col = c('green', 'forestgreen'),
        width = .9, space = c(0,1.5)
        )
abline(h=0)

barplot(DUgPD.g1.proportions, beside = TRUE, 
        names.arg = c("2011", "2012", "2013", "2014", "2015", "All Years", ""),
        main = c('No Checkup within 5 Years'), 
        col = c('green', 'forestgreen'),
        width = .9, space = c(0,1.5)
        )
legend("topright",
       inset=0,
       cex = .8,
       c("Insured","Uninsured"),
       pch=20,
       pt.cex = 2,
       col=c("green","forestgreen"),
       bty = "n"
       )
abline(h=0)

mtext('Difference in Doctor Utilization for Individuals with a Personal Doctor', outer = TRUE, font = 2)

dev.off()

```

***

![**Figure 2:** The plots above show the difference in the time since last general health checkup between the insured and uninsured groups. The plot on the left shows the proportion of individuals that have had a checkup within the past year for both insured and uninsured groups. The plot to the right shows the proportion of individuals that have not had a checkup in the last five years (including those that have never had a checkup) for both insured and uninsured groups. Note the difference in the range of the y-axis between the plot on the left and the plot on the right.](plots\Difference_in_Doctor_Utilization.png)

<br>

![**Figure 3:** The plots above depict the same measures as those shown in figure 2, but only for individuals who reported having a personal doctor.](plots\Difference_in_Doctor_Utilization_Given_PD.png)

***

 From figures 2 and 3 above we can see that the proportion of insured individuals that have had a general health checkup within the past year is greater than that for uninsured individuals. This is true across all years both when looking at all respondents and when restricting our investigation to only those that reported having a personal doctor. However, the difference between insured and uninsured is a little less in magnitude when we only look at respondents that have a personal doctor. Additionally, the proportion of uninsured individuals that have not seen a doctor in the last five years is higher than that for insured individuals. This is also true across all years and when we only look at respondents that reported having a personal doctor.
<br>
<br>

  Next we will perform Peason Chi-squared tests and rank correlation tests to determine if there is any association between insurance status and our measures of primary care access and the direction of that association.
<br>
<br>

### Tests of General Association and Rank Correlation

  The Pearson chi-squared tests confirmed the presence of an association between insurance status and having a personal doctor for every year from 2011 through 2015. Furthermore, the Kendall's tau-b and Goodman and Kruskal's gamma statistics confirm that the direction of this association is towards insured individuals being more likely to have a personal doctor. Table 1 lists the Pearson test-statistics and their associated p-valus for each year and for all years combined. The large test statistics and correspondingly low p-values indicate the association is highly statistically significant. Table 2 reports the calculated rank correlation statistics, their confidence intervals, their test-statistics and their p-values. Again, the large test-statistics and low p-values indicate that the positive correlation between insurance status and having a personal doctor is highly *statistically* significant. The difference in the magnitude of the tau-b and gamma statistics is due to the way they are calculated. The gamma statistic looks at the difference between the number of concordant and discordant pairs relative to the total number of *only discordant or concordant* pairs. So ties do not effect the gamma statistic. On the other hand, the tau-b statistic does take ties into account. For more information on the performance of the Pearson chi-squared test and the calculation of the rank correlation statistics please see the appendix (***link required***).
  
***

```{r, include=F}
### Calculating pearson statistics

vec <- c()
vec <- c(vec, 
         as.numeric(chisq.test(ST_PD_t11[,2:3])$statistic), 1, as.numeric(chisq.test(ST_PD_t11[,2:3])$p.value),
         as.numeric(chisq.test(ST_PD_t12[,2:3])$statistic), 1, as.numeric(chisq.test(ST_PD_t12[,2:3])$p.value),
         as.numeric(chisq.test(ST_PD_t13[,2:3])$statistic), 1, as.numeric(chisq.test(ST_PD_t13[,2:3])$p.value),
         as.numeric(chisq.test(ST_PD_t14[,2:3])$statistic), 1, as.numeric(chisq.test(ST_PD_t14[,2:3])$p.value),
         as.numeric(chisq.test(ST_PD_t15[,2:3])$statistic), 1, as.numeric(chisq.test(ST_PD_t15[,2:3])$p.value),
         as.numeric(chisq.test(ST_PD_ay[,2:3])$statistic), 1, as.numeric(chisq.test(ST_PD_ay[,2:3])$p.value))

pcs.PD <- matrix(vec, nrow = 6, ncol = 3,
                 dimnames = list(c("2011", "2012", "2013", "2014", "2015", "All Years"),
                                      c("Test Statistic", "Degrees of Freedom", "P-Value")),
                 byrow = T)

### Calculating concordance statistics

Rank.Correlation <- function(x, alpha = 0.05){
  
  z <- qnorm(alpha/2, lower.tail = F)
  cols <- dim(x)[2]
  n <- sum(x[1,]) + sum(x[2,])
  np <- (n*(n-1))/2
  SE.LS.approx <- sqrt((2*(2*n+5))/(9*n*(n-1)))
  
  T.pairs <- sum(x[1,])*(sum(x[1,])-1)/2 + sum(x[2,])*(sum(x[2,])-1)/2
  Tied.r <- T.pairs
  
  C.pairs <- 0
  D.pairs <- 0
  Tied.c <- 0
  for(i in 1:cols){
    if(i < cols){
      for(j in (i + 1):cols){
        C.pairs <- C.pairs + x[1,i]*x[2,j]
        D.pairs <- D.pairs + x[2,i]*x[1,j]
      }
    }
    
    T.pairs <- T.pairs + x[1,i]*x[2,i]
    Tied.c <- Tied.c + sum(x[,i])*(sum(x[,i])-1)/2
    
  }
  
  vt <- 0
  v1.c <- 0
  v2.c <- 0
  for(i in 1:cols){
    s <- sum(x[,i])*(sum(x[,i])-1)
    vt <- vt + s*(2*sum(x[,i])+5)
    v1.c <- v1.c + s
    v2.c <- v2.c + s*(sum(x[,i])-2)
  }
  
  vu <- 0
  v1.r <- 0
  v2.r <- 0
  for(i in 1:2){
    s <- sum(x[i,])*(sum(x[i,])-1)
    vu <- vu + s*(2*sum(x[i,])+5)
    v1.r <- v1.r + s
    v2.r <- v2.r + s*(sum(x[i,])-2)
  }
  
  v1 <- v1.c*v1.r/(2*n*(n-1))
  v2 <- v2.c*v2.r/(9*n*(n-1)*(n-2))
  
  v0 <- n*(n-1)*(2*n+5)
  
  v <- (v0 - vt - vu) / (18) + v1 + v2
 
  
  Ktau.a <- (C.pairs - D.pairs) / np
  Ktau.b <- (C.pairs - D.pairs) / sqrt( (np - Tied.r)*(np - Tied.c) )
  
  Z.a <- as.numeric( 3*(C.pairs - D.pairs) / sqrt(n*(n-1)*(2*n+5)/2) )
  pva <- pnorm(abs(Z.a), lower.tail = F)
  Z.a.Alt <- as.numeric( Ktau.a/SE.LS.approx )
  pva.Alt <- pnorm(abs(Z.a.Alt), lower.tail = F)
  
  Ta.LB <- Ktau.a - z*SE.LS.approx
  Ta.UB <- Ktau.a + z*SE.LS.approx
  
  Z.b <- as.numeric( (C.pairs - D.pairs) / sqrt(v) )
  pvb <- pnorm(abs(Z.b), lower.tail = F)
  Z.b.Alt <- as.numeric( Ktau.b/SE.LS.approx )
  pvb.Alt <- pnorm(abs(Z.b.Alt), lower.tail = F)
  
  Tb.LB <- Ktau.b - z*SE.LS.approx
  Tb.UB <- Ktau.b + z*SE.LS.approx
  
  gamma <- (C.pairs - D.pairs)/(C.pairs + D.pairs)
  SE.gamma <- sqrt(n*(1-gamma^2)/(C.pairs+D.pairs))
  Z.gamma <- as.numeric( gamma/SE.gamma )
  pvg <- pnorm(abs(Z.gamma), lower.tail = F)
  
  G.LB <- gamma - z*SE.gamma
  G.UB <- gamma + z*SE.gamma
  
  out <- matrix(c(Ta.LB, Tb.LB, G.LB, Ktau.a, Ktau.b, gamma, Ta.UB, Tb.UB, G.UB, Z.a, Z.b, Z.gamma, 
                  pva, pvb, pvg, Z.a.Alt, Z.b.Alt, NA, pva.Alt, pvb.Alt, NA),
                nrow = 3, ncol = 7,
                dimnames = list(c("Tau.a", "Tau.b", "Gamma"), 
                                c("Lower.Bound","Estimate", "Upper Bound", "TS", "p.val", "Alt.TS", "p.val")))
  
  out
}

roc.pd11 <- Rank.Correlation(ST_PD_t11[,2:3])
roc.pd12 <- Rank.Correlation(ST_PD_t12[,2:3])
roc.pd13 <- Rank.Correlation(ST_PD_t13[,2:3])
roc.pd14 <- Rank.Correlation(ST_PD_t14[,2:3])
roc.pd15 <- Rank.Correlation(ST_PD_t15[,2:3])
roc.pday <- Rank.Correlation(ST_PD_ay[,2:3])

```


```{r echo=FALSE,results='asis'}
library(pander)

### Table 1, Pearson statistics

pandoc.table(pcs.PD, caption = "**Table 1**: The Pearson chi-squared test-statistics for the general association between insurance status and having a personal doctor. The large test-statistics and p-values of virtually zero indicate that the association between insurance status and whether or not an individual has a personal doctor is highly statistically significant.", split.table = Inf)

```

<br>

```{r echo=FALSE,results='asis'}

### Table 2, concordance statistics

t11 <- cbind(c("Tau-b", "Gamma"),
              round(as.numeric(roc.pd11[2:3,1]), digits = 5),
              round(as.numeric(roc.pd11[2:3,2]), digits = 5),
              round(as.numeric(roc.pd11[2:3,3]), digits = 5),
              round(as.numeric(roc.pd11[2:3,4]), digits = 5),
              round(as.numeric(roc.pd11[2:3,5]), digits = 5))
colnames(t11) <- c("", "95% Lower Bound", "Estimate", "95% Upper Bound", "Test Statistic", "P-value")
rownames(t11) <- c("2011", "")

t12 <- cbind(c("Tau-b", "Gamma"),
              round(as.numeric(roc.pd12[2:3,1]), digits = 5),
              round(as.numeric(roc.pd12[2:3,2]), digits = 5),
              round(as.numeric(roc.pd12[2:3,3]), digits = 5),
              round(as.numeric(roc.pd12[2:3,4]), digits = 5),
              round(as.numeric(roc.pd12[2:3,5]), digits = 5))
rownames(t12) <- c("2012", "")

t13 <- cbind(c("Tau-b", "Gamma"),
              round(as.numeric(roc.pd13[2:3,1]), digits = 5),
              round(as.numeric(roc.pd13[2:3,2]), digits = 5),
              round(as.numeric(roc.pd13[2:3,3]), digits = 5),
              round(as.numeric(roc.pd13[2:3,4]), digits = 5),
              round(as.numeric(roc.pd13[2:3,5]), digits = 5))
rownames(t13) <- c("2013", "")

t14 <- cbind(c("Tau-b", "Gamma"),
              round(as.numeric(roc.pd14[2:3,1]), digits = 5),
              round(as.numeric(roc.pd14[2:3,2]), digits = 5),
              round(as.numeric(roc.pd14[2:3,3]), digits = 5),
              round(as.numeric(roc.pd14[2:3,4]), digits = 5),
              round(as.numeric(roc.pd14[2:3,5]), digits = 5))
rownames(t14) <- c("2014", "")

t15 <- cbind(c("Tau-b", "Gamma"),
              round(as.numeric(roc.pd15[2:3,1]), digits = 5),
              round(as.numeric(roc.pd15[2:3,2]), digits = 5),
              round(as.numeric(roc.pd15[2:3,3]), digits = 5),
              round(as.numeric(roc.pd15[2:3,4]), digits = 5),
              round(as.numeric(roc.pd15[2:3,5]), digits = 5))
rownames(t15) <- c("2015", "")

tay <- cbind(c("Tau-b", "Gamma"),
              round(as.numeric(roc.pday[2:3,1]), digits = 5),
              round(as.numeric(roc.pday[2:3,2]), digits = 5),
              round(as.numeric(roc.pday[2:3,3]), digits = 5),
              round(as.numeric(roc.pday[2:3,4]), digits = 5),
              round(as.numeric(roc.pday[2:3,5]), digits = 5))
rownames(tay) <- c("All", "Years")


rcts.PD <- rbind(t11,t12,t13,t14,t15,tay)
rm(t11, t12, t13, t14, t15, tay)

pandoc.table(rcts.PD, caption = "**Table 2**: The rank correlation statistics for the relationship between insurance status and having a personal doctor. The positive tau-b and gamma statistics indicate that having insurance is correlated with having a personal doctor. While the large test-statistics and p-values of virtually zero indicate that this correlation is highly statistically significant, the magnitude of the tau-b statistic indicates that the strength of the correlation is moderate.", split.table = Inf)

```

<br>

***

<br>

  The association between insurance status and doctor utilization was investigated both for all individuals and for individuals who reported having a personal doctor. For both of these groups the Pearson chi-squared test confirmed the presence of an association between insurance status and doctor utilization, while the rank correlation statistics confirmed that the direction of this association was towards individuals with insurance having a general health checkup more recently. Tables 3 and 4 report the Pearson chi-squared statistics for all individuals and for only individuals who reported having a personal doctor, respectively. The large test-statistics and p-values of virtually zero indicate that the association between insurance status and doctor utilization is highly statistically significant for every year, both when looking at all individuals and only individuals with a personal doctor. Tables 5 and 6 report the rank correlation statistics for all individuals and for only individuals who reported having a personal doctor, respectively. Again, the large test-statistics and p-values of approximately zero indicate that the positive correlation between insurance status and doctor utilization is highly statistically significant, the relatively small magnitudes of the tau-b estimates indicate that the strength of this correlation is not necessarily very strong. Moreover, the strength of the correlation is weaker in the group of individuals who reported having a personal doctor. 
  
***

```{r, echo=F, results="asis"}

### Caculate Pearson Statistics

vec <- c()
vec <- c(vec, 
         as.numeric(chisq.test(ST_CU_t11[,2:6])$statistic), 4, as.numeric(chisq.test(ST_CU_t11[,2:6])$p.value),
         as.numeric(chisq.test(ST_CU_t12[,2:6])$statistic), 4, as.numeric(chisq.test(ST_CU_t12[,2:6])$p.value),
         as.numeric(chisq.test(ST_CU_t13[,2:6])$statistic), 4, as.numeric(chisq.test(ST_CU_t13[,2:6])$p.value),
         as.numeric(chisq.test(ST_CU_t14[,2:6])$statistic), 4, as.numeric(chisq.test(ST_CU_t14[,2:6])$p.value),
         as.numeric(chisq.test(ST_CU_t15[,2:6])$statistic), 4, as.numeric(chisq.test(ST_CU_t15[,2:6])$p.value),
         as.numeric(chisq.test(ST_CU_ay[,2:6])$statistic), 4, as.numeric(chisq.test(ST_CU_ay[,2:6])$p.value))

pcs.CU <- matrix(vec, nrow = 6, ncol = 3,
                 dimnames = list(c("2011", "2012", "2013", "2014", "2015", "All Years"),
                                      c("Test Statistic", "Degrees of Freedom", "P-Value")),
                 byrow = T)

vec <- c()
vec <- c(vec, 
         as.numeric(chisq.test(ST_CUgPD_t11[,2:6])$statistic), 4, as.numeric(chisq.test(ST_CUgPD_t11[,2:6])$p.value),
         as.numeric(chisq.test(ST_CUgPD_t12[,2:6])$statistic), 4, as.numeric(chisq.test(ST_CUgPD_t12[,2:6])$p.value),
         as.numeric(chisq.test(ST_CUgPD_t13[,2:6])$statistic), 4, as.numeric(chisq.test(ST_CUgPD_t13[,2:6])$p.value),
         as.numeric(chisq.test(ST_CUgPD_t14[,2:6])$statistic), 4, as.numeric(chisq.test(ST_CUgPD_t14[,2:6])$p.value),
         as.numeric(chisq.test(ST_CUgPD_t15[,2:6])$statistic), 4, as.numeric(chisq.test(ST_CUgPD_t15[,2:6])$p.value),
         as.numeric(chisq.test(ST_CUgPD_ay[,2:6])$statistic), 4, as.numeric(chisq.test(ST_CUgPD_ay[,2:6])$p.value))

pcs.CUgPD <- matrix(vec, nrow = 6, ncol = 3,
                 dimnames = list(c("2011", "2012", "2013", "2014", "2015", "All Years"),
                                      c("Test Statistic", "Degrees of Freedom", "P-Value")),
                 byrow = T)

pandoc.table(pcs.CU, caption = "**Table 3**: The Pearson chi-squared test-statistics for the general association between insurance status and time since last general health checkup (doctor utilization). The large test-statistics and p-values of virtually zero indicate that the association between insurance status and doctor utilization is highly statistically significant for every year.", split.table = Inf)

```

<br>

```{r, echo=F, results="asis"}

pandoc.table(pcs.CUgPD, caption = "**Table 4**: The Pearson chi-squared test-statistics for the general association between insurance status and doctor utilization when only considering individuals who reported having a personal doctor. Although the test-statistics are smaller than those observed when looking at all individuals, they are still very large and the p-values are still virtually zero, indicating that the association between insurance status and doctor utilization is still highly statistically significant.", split.table = Inf)

```

<br>

```{r, echo=F, results="asis"}

### Calculate rank correlation statistics

roc.CU11 <- Rank.Correlation(ST_CU_t11[,2:6])
roc.CU12 <- Rank.Correlation(ST_CU_t12[,2:6])
roc.CU13 <- Rank.Correlation(ST_CU_t13[,2:6])
roc.CU14 <- Rank.Correlation(ST_CU_t14[,2:6])
roc.CU15 <- Rank.Correlation(ST_CU_t15[,2:6])
roc.CUay <- Rank.Correlation(ST_CU_ay[,2:6])

t11 <- cbind(c("Tau-b", "Gamma"),
              round(as.numeric(roc.CU11[2:3,1]), digits = 5),
              round(as.numeric(roc.CU11[2:3,2]), digits = 5),
              round(as.numeric(roc.CU11[2:3,3]), digits = 5),
              round(as.numeric(roc.CU11[2:3,4]), digits = 5),
              round(as.numeric(roc.CU11[2:3,5]), digits = 5))
colnames(t11) <- c("", "95% Lower Bound", "Estimate", "95% Upper Bound", "Test Statistic", "P-value")
rownames(t11) <- c("2011", "")

t12 <- cbind(c("Tau-b", "Gamma"),
              round(as.numeric(roc.CU12[2:3,1]), digits = 5),
              round(as.numeric(roc.CU12[2:3,2]), digits = 5),
              round(as.numeric(roc.CU12[2:3,3]), digits = 5),
              round(as.numeric(roc.CU12[2:3,4]), digits = 5),
              round(as.numeric(roc.CU12[2:3,5]), digits = 5))
rownames(t12) <- c("2012", "")

t13 <- cbind(c("Tau-b", "Gamma"),
              round(as.numeric(roc.CU13[2:3,1]), digits = 5),
              round(as.numeric(roc.CU13[2:3,2]), digits = 5),
              round(as.numeric(roc.CU13[2:3,3]), digits = 5),
              round(as.numeric(roc.CU13[2:3,4]), digits = 5),
              round(as.numeric(roc.CU13[2:3,5]), digits = 5))
rownames(t13) <- c("2013", "")

t14 <- cbind(c("Tau-b", "Gamma"),
              round(as.numeric(roc.CU14[2:3,1]), digits = 5),
              round(as.numeric(roc.CU14[2:3,2]), digits = 5),
              round(as.numeric(roc.CU14[2:3,3]), digits = 5),
              round(as.numeric(roc.CU14[2:3,4]), digits = 5),
              round(as.numeric(roc.CU14[2:3,5]), digits = 5))
rownames(t14) <- c("2014", "")

t15 <- cbind(c("Tau-b", "Gamma"),
              round(as.numeric(roc.CU15[2:3,1]), digits = 5),
              round(as.numeric(roc.CU15[2:3,2]), digits = 5),
              round(as.numeric(roc.CU15[2:3,3]), digits = 5),
              round(as.numeric(roc.CU15[2:3,4]), digits = 5),
              round(as.numeric(roc.CU15[2:3,5]), digits = 5))
rownames(t15) <- c("2015", "")

tay <- cbind(c("Tau-b", "Gamma"),
              round(as.numeric(roc.CUay[2:3,1]), digits = 5),
              round(as.numeric(roc.CUay[2:3,2]), digits = 5),
              round(as.numeric(roc.CUay[2:3,3]), digits = 5),
              round(as.numeric(roc.CUay[2:3,4]), digits = 5),
              round(as.numeric(roc.CUay[2:3,5]), digits = 5))
rownames(tay) <- c("All", "Years")

rcts.CU <- rbind(t11,t12,t13,t14,t15,tay)
rm(t11, t12, t13, t14, t15, tay)



roc.CUgPD11 <- Rank.Correlation(ST_CUgPD_t11[,2:6])
roc.CUgPD12 <- Rank.Correlation(ST_CUgPD_t12[,2:6])
roc.CUgPD13 <- Rank.Correlation(ST_CUgPD_t13[,2:6])
roc.CUgPD14 <- Rank.Correlation(ST_CUgPD_t14[,2:6])
roc.CUgPD15 <- Rank.Correlation(ST_CUgPD_t15[,2:6])
roc.CUgPDay <- Rank.Correlation(ST_CUgPD_ay[,2:6])

t11 <- cbind(c("Tau-b", "Gamma"),
              round(as.numeric(roc.CUgPD11[2:3,1]), digits = 5),
              round(as.numeric(roc.CUgPD11[2:3,2]), digits = 5),
              round(as.numeric(roc.CUgPD11[2:3,3]), digits = 5),
              round(as.numeric(roc.CUgPD11[2:3,4]), digits = 5),
              round(as.numeric(roc.CUgPD11[2:3,5]), digits = 5))
colnames(t11) <- c("", "95% Lower Bound", "Estimate", "95% Upper Bound", "Test Statistic", "P-value")
rownames(t11) <- c("2011", "")

t12 <- cbind(c("Tau-b", "Gamma"),
              round(as.numeric(roc.CUgPD12[2:3,1]), digits = 5),
              round(as.numeric(roc.CUgPD12[2:3,2]), digits = 5),
              round(as.numeric(roc.CUgPD12[2:3,3]), digits = 5),
              round(as.numeric(roc.CUgPD12[2:3,4]), digits = 5),
              round(as.numeric(roc.CUgPD12[2:3,5]), digits = 5))
rownames(t12) <- c("2012", "")

t13 <- cbind(c("Tau-b", "Gamma"),
              round(as.numeric(roc.CUgPD13[2:3,1]), digits = 5),
              round(as.numeric(roc.CUgPD13[2:3,2]), digits = 5),
              round(as.numeric(roc.CUgPD13[2:3,3]), digits = 5),
              round(as.numeric(roc.CUgPD13[2:3,4]), digits = 5),
              round(as.numeric(roc.CUgPD13[2:3,5]), digits = 5))
rownames(t13) <- c("2013", "")

t14 <- cbind(c("Tau-b", "Gamma"),
              round(as.numeric(roc.CUgPD14[2:3,1]), digits = 5),
              round(as.numeric(roc.CUgPD14[2:3,2]), digits = 5),
              round(as.numeric(roc.CUgPD14[2:3,3]), digits = 5),
              round(as.numeric(roc.CUgPD14[2:3,4]), digits = 5),
              round(as.numeric(roc.CUgPD14[2:3,5]), digits = 5))
rownames(t14) <- c("2014", "")

t15 <- cbind(c("Tau-b", "Gamma"),
              round(as.numeric(roc.CUgPD15[2:3,1]), digits = 5),
              round(as.numeric(roc.CUgPD15[2:3,2]), digits = 5),
              round(as.numeric(roc.CUgPD15[2:3,3]), digits = 5),
              round(as.numeric(roc.CUgPD15[2:3,4]), digits = 5),
              round(as.numeric(roc.CUgPD15[2:3,5]), digits = 5))
rownames(t15) <- c("2015", "")

tay <- cbind(c("Tau-b", "Gamma"),
              round(as.numeric(roc.CUgPDay[2:3,1]), digits = 5),
              round(as.numeric(roc.CUgPDay[2:3,2]), digits = 5),
              round(as.numeric(roc.CUgPDay[2:3,3]), digits = 5),
              round(as.numeric(roc.CUgPDay[2:3,4]), digits = 5),
              round(as.numeric(roc.CUgPDay[2:3,5]), digits = 5))
rownames(tay) <- c("All", "Years")

rcts.CUgPD <- rbind(t11,t12,t13,t14,t15,tay)
rm(t11, t12, t13, t14, t15, tay)

pandoc.table(rcts.CU, caption = "**Table 5**: The rank correlation statistics for the relationship between insurance status and time since last general health checkup (doctor utilizationt). The positive tau-b and gamma statistics indicate that having insurance is correlated with having a checkup more recently. While the large test-statistics and p-values of virtually zero indicate that this correlation is highly statistically significant, the magnitude of the tau-b statistic indicates that the strength of the correlation is not very strong.", split.table = Inf)

```

<br>

```{r, echo=F, results="asis"}

pandoc.table(rcts.CUgPD, caption = "**Table 6**: The rank correlation statistics for the relationship between insurance status and doctor utilization when considering only individuals who reported having a personal doctor. Again, the positive tau-b and gamma statistics (and the p-values of approximately zero) indicate that having insurance is correlated with having a checkup more recently. However, the magnitude of the tau-b statistics are less than those observed when considering all individuals. Thus the strength of the correlation appears weaker when cosidering only individuals who reported having a personal doctor.", split.table = Inf)

```

<br>

***
  For all three measures of primary care accessibility and utilization, the Pearson chi-squared tests confirmed a general association with insurance status. Furthermore, the rank correlation tests showed that the direction of this association was towards individuals with insurance having better primary care access. For more information on how these tests were performed see the example in the appendix (***link required***)
  
  Now that we have confirmed the presence and direction of association between insurance status and our measures of primary care access, we will examine in more detail the degree of this relationship.

<br>

### Absolute and Relative Difference of Proportions

  For each of our three measures, we will examine how the proportion of individuals at different levels of our measures differ between the insured and uninsured groups. For more details on how the absolute and relative differences in proportions were calculated please see the appendix (***Link Required***).
  
  In the previous sections we showed that there is a positive correlation between having insurance and having a personal doctor. Table 7 lists the estimated absolute difference in proportion between individuals in the insured group that have a doctor and individuals in the uninsured group that have a doctor. Figure 4 graphically shows these absolute differences in proportions. The small line segments on top of each bar show the 95% confidence intervals for the difference in proportions. Note that the y-axis only covers a small range, so although the differences in proportions may vary in a *statistically* significant manner (note the confidence intervals do not overlap, except for 2013 and 2014), the magnitude of this variation appears small.
  
***

```{r, include=F}

PD.propdif <- function(x, alpha){
  
  df <- x
  
  z <- qnorm(alpha/2, lower.tail = F)
  n1 <- as.numeric( sum(df[1,2:3]) )
  n2 <- as.numeric( sum(df[2,2:3]) )

  p1 <- as.numeric( df[1,2]/sum(df[1,2:3]) )
  p2 <- as.numeric( df[2,2]/sum(df[2,2:3]) )
  dif <- p1 - p2
  
  LB <- dif - z*sqrt( (p1*(1-p1))/n1 + (p2*(1-p2))/n2 )
  UB <- dif + z*sqrt( (p1*(1-p1))/n1 + (p2*(1-p2))/n2 )
  
  vec <- c(LB, dif, UB)
  vec
}

PD.pd <- c()
PD.pd <- c(PD.pd, PD.propdif(ST_PD_t11, 0.05))
PD.pd <- c(PD.pd, PD.propdif(ST_PD_t12, 0.05))
PD.pd <- c(PD.pd, PD.propdif(ST_PD_t13, 0.05))
PD.pd <- c(PD.pd, PD.propdif(ST_PD_t14, 0.05))
PD.pd <- c(PD.pd, PD.propdif(ST_PD_t15, 0.05))
PD.pd <- c(PD.pd, PD.propdif(ST_PD_ay, 0.05))

Persdoc.pdif.95CI <- matrix(PD.pd, nrow = 6, ncol = 3, byrow = TRUE, 
                            dimnames = list(c("2011", "2012", "2013", "2014", "2015", "All"), 
                                            c("Lower Bound", "Estimate", "Upper Bound")))

png("plots/Difference_in_Props_PD.png",
     height = 400, width = 480)
 
barcenters <- barplot(Persdoc.pdif.95CI[,2], 
                      ylim = c( min(Persdoc.pdif.95CI[,1]) - 0.001  , max(Persdoc.pdif.95CI[,3]) ),
                      main = "Absolute Difference of Proportion of Persons with a Personal Doctor
                      \n Insured v.s. Uninsured", 
                      xpd = FALSE, cex.names = .9, cex.main = 1 )

abline(h=min(Persdoc.pdif.95CI[,1]) - 0.001)

segments(barcenters, Persdoc.pdif.95CI[,1], barcenters, Persdoc.pdif.95CI[,3], 
         lwd = 1.5)

arrows(barcenters, Persdoc.pdif.95CI[,1], barcenters, Persdoc.pdif.95CI[,3], 
       lwd = 1.5, angle = 90, code = 3, length = 0.05)

dev.off()

```

```{r, echo=F, results="asis"}

pandoc.table(Persdoc.pdif.95CI, caption = "**Table 7:** 95% Confidence intervals for the absolute differences between the proportion of insured individuals with a doctor and uninsured individuals with a doctor. Note that although the absolute differences are very close from year to year they do generally decrease from 2011 to 2015.", digits = 5)

```

<br>

![**Figure 4:** Graphical depiction of the absolute difference in proportion of insured individuals with a doctor compared to uninsured individuals with doctor. Note that the range of the y-axis is small so that although the absolute differences decrease from 2011 through 2015, the magnitude of the reduction is small. ](plots/Difference_in_Props_PD.png)

***

<br>

  Table 8 and figure 5 show the confidence intervals for the relative difference in the proportion of insured individuals with a doctor to uninsured individuals with a doctor. When looking at all the years combined, insured individuals were 2.13 times more likely to have a personal doctor than uninsured individuals. While it is true that each year insured individuals were more likely to have a doctor when compared to uninsured individuals, this increased likelihood is not constant through all years. Rather, it appears to increase from 2.11 in 2011 to 2.17 in 2014 before dropping back down to 2.13 in 2015. This is in contrast to the change in absolute difference in proportion (table 7 and figure 4) which appeared to continually decrease from 2011 through 2015.
  
***
  
```{r, echo=F, results="asis"}

Relative.Risk <- function(x, coi = c(1), alpha = 0.05){
  
  z <- qnorm(alpha/2, lower.tail = F)
  
  n1 <- as.numeric( sum(x[1,]) )
  n2 <- as.numeric( sum(x[2,]) )
  
  p1 <- as.numeric( x[1,coi]/n1 )
  p2 <- as.numeric( x[2,coi]/n2 )
  
  rr <- p1/p2
  v <- sqrt( (1-p1)/x[1,coi] + (1-p2)/x[2,coi] )
  
  LB <- rr*exp(-z*v)
  UB <- rr*exp(z*v)
  
  vec <- c(LB, rr, UB)
  vec

}

PD.RR <- matrix(c(Relative.Risk(ST_PD_t11[,2:3]),
                  Relative.Risk(ST_PD_t12[,2:3]),
                  Relative.Risk(ST_PD_t13[,2:3]),
                  Relative.Risk(ST_PD_t14[,2:3]),
                  Relative.Risk(ST_PD_t15[,2:3]),
                  Relative.Risk(ST_PD_ay[,2:3])),
                nrow = 6, ncol = 3, byrow = T,
                dimnames = list(c("2011", "2012", "2013", "2014", "2015", "All Years"),
                                c("Lower Bound", "Estimate", "Upper Bound"))
                )

pandoc.table(PD.RR, caption = "**Table 8:** 95% Confidence intervals for the relative differences between the proportion of insured individuals with a doctor and uninsured individuals with a doctor. Note that although the relative differences are very close from year to year they do generally decrease from 2011 to 2015.", digits = 5)

```

<br>

```{r, include=F}

png("plots/Relative_Difference_in_Props_PD.png",
     height = 480, width = 480)

plot(x = c(1:6), y = PD.RR[,2], 
     main = "Relative Difference of Proportion of Persons with a Personal Doctor \n Insured v.s. Uninsured", 
     ylab = "Relative Difference",
     xlab = NA,
     xlim = c(1,6), 
     ylim = c(2.09, 2.17), 
     pch=20, col = "red",
     axes = FALSE, cex.main = 1, cex = 1, cex.lab = 1)
box()

axis(1, at = c(1:6), labels = c ("2011", "2012", "2013", "2014", "2015", "All Years"), cex.axis = 1)
axis(2, at = seq(from = 2.09, to = 2.17, by = 0.01), las = 2, cex.axis = .8)


segments(c(1:6), as.numeric(PD.RR[,1]), c(1:6), as.numeric(PD.RR[,3]), lwd = 1.5)
arrows(c(1:6), as.numeric(PD.RR[,1]), c(1:6), as.numeric(PD.RR[,3]), lwd = 1.5, angle = 90, code = 3, length = 0.03)

dev.off()

```

![**Figure 5:** 95% confidence intervals for relative difference in proportion of insured individuals with a doctor compared to uninsured individuals with doctor. As with absolute difference, the relative differences fluctuate from year to year but the magnitude of this variation is small (note the range of the y-axis). Also, while the absolute differences appeared to consistently decrease from 2011 through 2015, that is not the case with the relative differences.](plots/Relative_Difference_in_Props_PD.png)

***

<br>

  Table 9 shows the absolute differences between the proportion of insured individuals that have had a checkup within a year and the proportion of uninsured individuals that have. Table 10 shows the same but when considering only indiviuals that reported having a personal doctor. For all the years combined the absolute difference in proportion was about 0.34 when considering all individuals and about 0.22 when considering only individuals that had a personal doctor. Also note, that the absolute differences for both groups tend to decrease slightly from 2011 to 2015. Figure 6 shows the absolute differences for each year in barchart form where the decreases from 2011 to 2015 are easier to see. While most of the changes in absolute difference from year to year are statistically significant (note that the confidence intervals for consecutive years do not overlap, except for 2011 and 2012), the magnitudes of these changes are small.

***

```{r, echo=F, results="asis"}

CU.AbandRR <- function(x, alpha = 0.05){

  z <- qnorm(alpha/2, lower.tail = F)
  
  n1 <- as.numeric( sum(x[1,]) )
  n2 <- as.numeric( sum(x[2,]) )
  
  n11 <- as.numeric(x[1,1])
  n21 <- as.numeric(x[2,1])
  
  n1g5 <- as.numeric(sum(x[1,4:5]))
  n2g5 <- as.numeric(sum(x[2,4:5]))
  
  p11 <- n11 / n1
  p21 <- n21 / n2
  
  p1g5 <- n1g5 / n1
  p2g5 <- n2g5 / n2
  
  dif.1 <- p11 - p21
  se.1 <- sqrt( (p11*(1-p11))/n1 + (p21*(1-p21))/n2 )
  LB.d1 <- dif.1 - z*se.1
  UB.d1 <- dif.1 + z*se.1
  
  dif.g5 <- p2g5 - p1g5
  se.g5 <- sqrt( (p2g5*(1-p2g5))/n2 + (p1g5*(1-p1g5))/n1 )
  LB.dg5 <- dif.g5 - z*se.g5
  UB.dg5 <- dif.g5 + z*se.g5
  
  rr.1 <- p11 / p21
  v.1 <- sqrt( (1-p11)/n11 + (1-p21)/n21 )
  LB.r1 <- rr.1*exp(-z*v.1)
  UB.r1 <- rr.1*exp(z*v.1)
  
  rr.g5 <- p2g5 / p1g5
  v.g5 <- sqrt( (1-p2g5)/n2g5 + (1-p1g5)/n1g5 )
  LB.rg5 <- rr.g5*exp(-z*v.g5)
  UB.rg5 <- rr.g5*exp(z*v.g5)
  
  vec <- c(LB.d1, dif.1, UB.d1, 
           LB.r1, rr.1, UB.r1, 
           LB.dg5, dif.g5, UB.dg5, 
           LB.rg5, rr.g5, UB.rg5)
  
  vec
}

DU <- matrix(c(CU.AbandRR(ST_CU_t11[,2:6]),
               CU.AbandRR(ST_CU_t12[,2:6]),
               CU.AbandRR(ST_CU_t13[,2:6]),
               CU.AbandRR(ST_CU_t14[,2:6]),
               CU.AbandRR(ST_CU_t15[,2:6]),
               CU.AbandRR(ST_CU_ay[,2:6])),
             nrow = 6, ncol = 12, byrow = T,
             dimnames = list(c("2011", "2012", "2013", "2014", "2015", "All Years"),
                             rep(c("Lower Bound", "Estimate", "Upper Bound"),4) )
             )

DUgPD <- matrix(c(CU.AbandRR(ST_CUgPD_t11[,2:6]),
               CU.AbandRR(ST_CUgPD_t12[,2:6]),
               CU.AbandRR(ST_CUgPD_t13[,2:6]),
               CU.AbandRR(ST_CUgPD_t14[,2:6]),
               CU.AbandRR(ST_CUgPD_t15[,2:6]),
               CU.AbandRR(ST_CUgPD_ay[,2:6])),
             nrow = 6, ncol = 12, byrow = T,
             dimnames = list(c("2011", "2012", "2013", "2014", "2015", "All Years"),
                             rep(c("Lower Bound", "Estimate", "Upper Bound"),4) )
             )

pandoc.table(DU[,1:3], caption = "**Table 9:** 95% Confidence intervals for the absolute differences between the proportion of insured individuals who have had a checkup within a year and the proportion of uninsured individuals that have. Note that although the differences are very close from year to year they do generally decrease from 2011 to 2015.", digits = 5)

```

<br>

```{r, echo=F, results="asis"}

pandoc.table(DUgPD[,1:3], caption = "**Table 10:** 95% Confidence intervals for the absolute differences between the proportion of insured and uninsured individuals who have had a checkup within a year, only considering individuals who reported having personal doctor. Note that although the differences are very close from year to year they do generally decrease from 2011 to 2015.", digits = 5)

```

<br>

```{r, include=F}

png("plots/Abs_Diff_CU1Y.png",
     height = 400, width = 760)

par(mfrow=c(1,2))
 
barcenters <- barplot(DU[,2], 
                      ylim = c( .317, .347 ),
                      main = NA,
                      sub = "All Individuals",
                      xpd = FALSE, cex.names = .9, cex.sub = .9 )

abline(h=.317)

segments(barcenters, DU[,1], barcenters, DU[,3], 
         lwd = 1.5, col = "red")

arrows(barcenters, DU[,1], barcenters, DU[,3], 
       lwd = 1.5, angle = 90, code = 3, length = 0.05, col = "red")

##

barcenters <- barplot(DUgPD[,2], 
                      ylim = c( .187, .228 ),
                      main = NA,
                      sub = "Individuals with a Personal Doctor",
                      xpd = FALSE, cex.names = .9, cex.sub = .9 )

abline(h=.187)

segments(barcenters, DUgPD[,1], barcenters, DUgPD[,3], 
         lwd = 1.5, col = "red")

arrows(barcenters, DUgPD[,1], barcenters, DUgPD[,3], 
       lwd = 1.5, angle = 90, code = 3, length = 0.05, col = "red")

mtext('Absolute Difference in Doctor Utilization:\n Proportion who have had a Checkup within 1 Year', 
       outer = T, font = 2, cex = .9, adj = .5, padj = 2)

dev.off()

```

![**Figure 6:** The absolute difference between the proportion of insured individuals who have had a general health checkup within one year and uninsured individuals who have. The red lines at the top of each bar represent the confidence intervals. Note the plot on the left is when considering all respondents to the BRFSS survey, while the plot on the right is when considering only respondents who reported having a personal doctor. Note the difference in the range of the y-axis for the two plots.](plots/Abs_Diff_CU1Y.png)

***

<br>

  Table 11 gives the confidence intervals for the relative differences between the proportion of insured individuals that have had a checkup within a year and the proportion of uninsured individuals that have. Table 12 also reports the confidence intervals for these relative differences, but when considering only individuals that reported having a personal doctor. When looking at all the years combined, individuals with insurance are about 1.84 times as likely to have had a checkup within a year. When we only consider individuals who reported having a doctor this figure drops to about 1.37 times as likely. Also note that, as with absolute difference, the relative differnce decreases from 2011 to 2015. Figure 7 shows this visually. The trend appears more steady when looking at all individuals than when considering only individuals who have a personal doctor, but it is present for both groups. When looking at all individuals, the relative difference drops from about 1.90 in 2011 to around 1.75 in 2015. When considering only individuals that have a doctor the drop is similar in magnitude, from 1.41 in 2011 to 1.31 in 2015.
  
***
  
```{r, echo=F, results="asis"}

pandoc.table(DU[,4:6], caption = "**Table 11:** 95% Confidence intervals for the relative differences between the proportion of insured individuals who have had a checkup within a year and the proportion of uninsured individuals that have. Note that although the relative differences are close from year to year they do generally decrease from 2011 to 2015.", digits = 5)

```

<br>

```{r, echo=F, results="asis"}

pandoc.table(DUgPD[,4:6], caption = "**Table 12:** 95% Confidence intervals for the relative differences between the proportion of individuals who have had a checkup within a year, only considering individuals who reported having a personal doctor. Note that although the relative differences are close from year to year they do generally decrease from 2011 to 2015.", digits = 5)

```

<br>

```{r, include=F}

png("plots/Rel_Diff_CU1Y.png",
     height = 400, width = 760)

par(mfrow=c(1,2))
 
barcenters <- barplot(DU[,5], 
                      ylim = c( 1.75, 1.90 ),
                      main = NA,
                      sub = "All Individuals",
                      xpd = FALSE, cex.names = .9, cex.sub = .9 )

abline(h=1.75)

segments(barcenters, DU[,4], barcenters, DU[,6], 
         lwd = 1.5, col = "red")

arrows(barcenters, DU[,4], barcenters, DU[,6], 
       lwd = 1.5, angle = 90, code = 3, length = 0.05, col = "red")

##

barcenters <- barplot(DUgPD[,5], 
                      ylim = c( 1.30, 1.41 ),
                      main = NA,
                      sub = "Individuals with a Personal Doctor",
                      xpd = FALSE, cex.names = .9, cex.sub = .9 )

abline(h=1.30)

segments(barcenters, DUgPD[,4], barcenters, DUgPD[,6], 
         lwd = 1.5, col = "red")

arrows(barcenters, DUgPD[,4], barcenters, DUgPD[,6], 
       lwd = 1.5, angle = 90, code = 3, length = 0.05, col = "red")

mtext('Relative Difference in Doctor Utilization:\n Proportion who have had a Checkup within 1 Year', 
       outer = T, font = 2, cex = .9, adj = .5, padj = 2)

dev.off()

```

![**Figure 7:** The relative difference between the proportion of insured individuals who have had a general health checkup within one year and uninsured individuals who have. The red lines at the top of each bar represent the confidence intervals. Note the plot on the left is when considering all respondents to the BRFSS survey, while the plot on the right is when considering only respondents who reported having a personal doctor. Note the difference in the range of the y-axis for the two plots. For both groups the relative difference changes decrease from 2011 to 2015, but the trend seems more consistent for the group that includes both individuals with and without a personal doctor.](plots/Rel_Diff_CU1Y.png)

***

<br>

 Table 13 shows the absolute difference between the proportion of uninsured individuals that have not had a checkup within five years and the proportion of insured individuals that have not. Note that in this case the difference is between uninsured and insured, not the other way around. So, the absolute diference of 0.182 for all the years combined means the proportion of insured individuals that have not had a checkup within five years is 0.182 *less* than the proportion of uninsured individuals that have not. Table 14 reports the same information but when considering only individuals who have a personal doctor. The absolute difference in proportions is much less when considering only individuals with personal doctors than when considering all individuals.
 
***

```{r, echo=F, results="asis"}

pandoc.table(DU[,7:9], caption = "**Table 13:** 95% Confidence intervals for the absolute differences between the proportion of uninsured individuals who have not had a checkup within five years and the proportion of insured individuals that have not.", digits = 5)

```

<br>

```{r, echo=F, results="asis"}

pandoc.table(DUgPD[,7:9], caption = "**Table 14:** 95% Confidence intervals for the absolute differences between the proportion of individuals who have not had a checkup within five years, only considering individuals who reported having a personal doctor.", digits = 5)

```

<br>

```{r, include=F}

png("plots/Abs_Diff_CUg5Y.png",
     height = 400, width = 760)

par(mfrow=c(1,2))
 
barcenters <- barplot(DU[,8], 
                      ylim = c( .178, .187 ),
                      main = NA,
                      sub = "All Individuals",
                      xpd = FALSE, cex.names = .9, cex.sub = .9 )

abline(h=.178)

segments(barcenters, DU[,7], barcenters, DU[,9], 
         lwd = 1.5, col = "red")

arrows(barcenters, DU[,7], barcenters, DU[,9], 
       lwd = 1.5, angle = 90, code = 3, length = 0.05, col = "red")

##

barcenters <- barplot(DUgPD[,8], 
                      ylim = c( 0.080, 0.088 ),
                      main = NA,
                      sub = "Individuals with a Personal Doctor",
                      xpd = FALSE, cex.names = .9, cex.sub = .9 )

abline(h=0.080)

segments(barcenters, DUgPD[,7], barcenters, DUgPD[,9], 
         lwd = 1.5, col = "red")

arrows(barcenters, DUgPD[,7], barcenters, DUgPD[,9], 
       lwd = 1.5, angle = 90, code = 3, length = 0.05, col = "red")

mtext('Absolute Difference in Doctor Utilization:\n Proportion who have not had a Checkup within 5 Years', 
       outer = T, font = 2, cex = .9, adj = .5, padj = 1.5)

dev.off()

```

![**Figure 8:** The absolute difference between the proportion of uninsured individuals who have not had a general health checkup within five years and insured individuals who have not. The red lines at the top of each bar represent the confidence intervals. The difference is measures as the proportion for uninsured indviduals minus the proportion for insured individuals, so a positive difference indicates the the proportion of uninsured that have not had a checkup within five years is greater than the proportion of insured indviduals that have not. Note the plot on the left is when considering all respondents to the BRFSS survey, while the plot on the right is when considering only respondents who reported having a personal doctor. Also note the difference in the range of the y-axis between the two plots.](plots/Abs_Diff_CUg5Y.png)

***

<br>

 Table 15 reports the relative difference between the proportion of uninsured individuals that have not had a checkup within five years and the proportion of insured individuals that have not. Again, as with the absolute difference reported in tables 13 and 14, we are comparing uninsured to insured, not the other way around. So a relative difference greater than one indicates that uninsured individuals are *more* likely to not have had a checkup within five years than insured individuals are. For instance, the relative difference of about 3.87 for all years combined indicates that when looking at all years, uninsured individuals are 3.87 times as likely to not have had a checkup within five years than insured individuals. Table 16 reports the same information but only considering individuals that have a personal doctor. Note that the relative difference for all years is slightly lower in the group that had a personal doctor (about 3.29 compared to 3.87). Figure 9 gives a visual of the relative differences observed for each year and for all years combined. Note that in contrast to the all the relationships previously looked at (where the difference between insured and uninsured appeared to decrease slightly from 2011 to 2015), the relative difference here does not appear to steadily decrease from 2011 to 2015 but rather to peak around 2013 and 2014.
 
 ***

```{r, echo=F, results="asis"}

pandoc.table(DU[,10:12], caption = "**Table 15:** 95% Confidence intervals for the relative differences between the proportion of uninsured individuals who have not had a checkup within five years and the proportion of insured individuals that have not.", digits = 5)

```

<br>

```{r, echo=F, results="asis"}

pandoc.table(DUgPD[,10:12], caption = "**Table 16:** 95% Confidence intervals for the relative differences between the proportion of individuals who have not had a checkup within five years, only considering individuals who reported having a personal doctor.", digits = 5)

```

<br>

```{r, include=F}

png("plots/Rel_Diff_CUg5Y.png",
     height = 400, width = 760)

par(mfrow=c(1,2))
 
barcenters <- barplot(DU[,11], 
                      ylim = c( 3.75, 4.10 ),
                      main = NA,
                      sub = "All Individuals",
                      xpd = FALSE, cex.names = .9, cex.sub = .9 )

abline(h=3.75)

segments(barcenters, DU[,10], barcenters, DU[,12], 
         lwd = 1.5, col = "red")

arrows(barcenters, DU[,10], barcenters, DU[,12], 
       lwd = 1.5, angle = 90, code = 3, length = 0.05, col = "red")

##

barcenters <- barplot(DUgPD[,11], 
                      ylim = c( 3.00, 3.50 ),
                      main = NA,
                      sub = "Individuals with a Personal Doctor",
                      xpd = FALSE, cex.names = .9, cex.sub = .9 )

abline(h=3.00)

segments(barcenters, DUgPD[,10], barcenters, DUgPD[,12], 
         lwd = 1.5, col = "red")

arrows(barcenters, DUgPD[,10], barcenters, DUgPD[,12], 
       lwd = 1.5, angle = 90, code = 3, length = 0.05, col = "red")

mtext('Relative Difference in Doctor Utilization:\n Proportion who have not had a Checkup within 5 Years', 
       outer = T, font = 2, cex = .9, adj = .5, padj = 1.5)

dev.off()

```

![**Figure 9:** The relative difference between the proportion of uninsured individuals who have not had a general health checkup within five years and insured individuals who have not. The red lines at the top of each bar represent the confidence intervals. The difference is measures as the ratio of the proportion for uninsured indviduals that have not had a checkup within five years to the proportion uf insured individuals that have not. Thus, relative difference greater than 1 indicates that uninsured individuals are more likely to not have had a checkup within five years. Note the plot on the left is when considering all respondents to the BRFSS survey, while the plot on the right is when considering only respondents who reported having a personal doctor.](plots/Rel_Diff_CUg5Y.png)

<br>
<br>
<br>
<br>
<br>
<br>
<br>


































